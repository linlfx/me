7 FreeSWITCH WebRTC和Mod_Verto
=============================================================================

WebRTC非常流行，在这里你可以找到需要的理论知识和实现示例。

我们将学习：
WebRTC是什么，它如何工作；
加密和NAT穿越（STUN、TURN、等）；
信令和媒体；
与PSTN和SIP设备互联；
FreeSWITCH是一个WebRTC服务器、网关和应用服务器；
SIP信令客户端（SIP.js）；
Verto信令客户端（mod_verto，verto.js）。

WebRTC只是关于媒体，没有规定信令系统。流行的信令系统有SIP、XMPP或自定义的协议。WebRTC的媒体流必须是加密的。

——————————————————————————————————————————
超越P2P - WebRTC到通讯网络和服务
——————————————————————————————————————————

WebRTC是一个为浏览器基于网络发送媒体给其他人的技术，P2P，也可能基于转发服务器（TURN），如果无法直接连接其他人时。

没有目录，没有方法发现其他人，也没有方法去呼叫用户，即使我们知道在哪里可以呼叫他。
没有方法来转移呼叫，不能反应用户忙，或拒绝接听，等等。

我们说WebRTC是一个半成品的电话，你可以直接连接另一部半成品电话，它们可以通话。然而，如果你想和另一个设备通话，你必须找到它，并加入连线。

没有拔号盘、没有电信中心办公室、没有互相连线而只是基于互联网、没有电话交换机（PBX）。不能呼叫你奶奶，不能操作互动式语音应答（IVR）。

我们需要整合WebRTC的媒体能力，与电信服务组成一个强大的系统。

WebRTC网关和WebRTC应用服务器，对我们来说是一样的表述。

——————————————————————————————————————————
WebRTC网关和应用服务
——————————————————————————————————————————

需要被解决的问题是：我们能在信令层面实现得很好，甚至使用JavaScript实现一个完整的SIP信令栈。但是这些只是网络和媒体层面，WebRTC只是与已存在的电信世界有点兼容，它们使用相似的技术和概念，协议主要是基于VoIP的实现演变而来。

在网络层面，WebRTC使用ICE协议来基于STUN和TURN服务器穿透NAT，ICE被设计为解决所有NAT问题的网络标准，但是它即没有在电信基础设施实现，也没有在大部分VoIP设备实现。而且，不同端点的ICE候选（浏览器认为能找到它的各种不同的地址）需要在SDP中传递和协商，使用相同的方法协商媒体编码。穿透公司的防火墙（UDP被挡、TCP只开80和443、可能还有代理 ）是绝对必要的，对于WebRTC的部署。

在网络层面，WebRTC指定的编码（视频是V8, 音频是Opus）与电信世界不相容，只有G711音频编码可以通用。

更糟的是，所有媒体都是以DTLS为Key加密为SRTP进行传输，这个目前电信基础设施并不关注。

所以，我们需要创建信令层，然后转换网络传输，转换编码，管理SDP中的ICE候选的挑选，允许接入大量现成的服务（PSTN、IVR、PBX、会议室、等等），然后补足指定的功能和新的互联服务到现有服务，用于WebRTC端点的唯一能力。
这就是FreeSWITCH的工作。

——————————————————————————————————————————
什么架构？现有服务进入Web还是Web进入电信？
——————————————————————————————————————————

基于Web的实时通讯：基于刚才看到的积木，我们能用许多方法来实现它。

我们有一个自由：信令。我的意思是媒体无论如何都通过SDP协议，通过WebSocket来传递通过DTLS的Key加密的SRTP包。

我们仍有一个任务是选择如何找到终端来交互媒体数据，这是一个目录、地区、注册、路由、参与、状态等的运用。

最后，你需要在浏览器中用JavaScript包来实现信令，通过可能的机制（Comet、WebSockets、WebRTC Data Channel）找到另一个通讯终端。

实现上归结为不同的可能：
SIP
XMPP
内部信令实现
VERTO（开源）

SIP是方为人知的，包含在许多电话和VoIP信令中。另一个很大实现是基于XMPP的实时消息和聊天。这两个信令经常一起使用，虽然它们都可以扩展来实现另一个。

SIP和XMPP被设计为可扩展的和模块化的，SIP的特点是一个抽象协议，用于管理session（session可以是有一个开始和结束时间，是一个语音或视频呼叫，屏幕共享，白板，一个合作平台，一个付款，一个消息，等等）。

已经有了很好的JavaScript实现（sip.js, jssip, sipml, xmpp有strophe, stanza.io, jingle.js）

如果你运行Skype或类似的服务， 你可以选择来管理，非公开的协议，并使用JavaScript来实现。所以你可以扩展你的服务延伸到浏览器，并开发它们通用的传输和媒体技术。

VERTO是我们的开源的信令建议，从Web应用开发者角度设计，考虑到很高程度的FreeSWITCH提供的服务与浏览器的集成。它在FreeSWITCH网站被以模块（mod_verto）的形式实现，在浏览器端基于使用verto.js，并使用JSON数据。

——————————————————————————————————————————
FreeSWITCH容纳所有
——————————————————————————————————————————

FreeSWITCH实现所有WebRTC低级协议、编码和需求，它将加密，SRTP、DTLS、RTP、WebSocket和安全的WebSocket传输。有了这些，它能通过mod_sofia服务基于WebRTC的SIP终端（它们会是SIP电话，就像其他软或硬SIP电话），它也可以通过mod_jingle与XMPP通讯。

关键，FreeSWITCH从一开始就支持高清媒体，不管是音频还是视频。支持OPUS音频编码开始于很多年前，是一个首创功能，这些年进化到可以在丢失40%数据包的情况下自己修复。WebRTC的V8视频编码可以支持高清 （1920*1080）。FreeSWITCH的设计从一开始就希望成为多媒体中心。

——————————————————————————————————————————
什么是Verto（module和jslib）？
——————————————————————————————————————————

Verto是一个FreeSWITCH模块（mod_verto），它允许基于wss与FreeSWITCH使用JSON交互。所有FreeSWITCH的功能都可以被Verto使用：session管理、呼叫控制、文本消息、用户数据交互和同步。注意：『用户数据交换和同步』。

Verto像事件套接字层（ESL）：任何你能在ESL做的事（订阅、发送和接收消息），你都可以在Verto做，但Verto实际上能做更多，Verto也可以在WebRTC上做高级控制。

Verto有一个JavaScript库：verto.js，使用verto.js可以让web开发者进行视频会议，使网站只用几行代码增加到CRM系统的合作平台，使用web开发者熟悉的逻辑，不需要参考类似SIP这样的外部知识。

同时，Verto允许用很简单的方法来扩展你已存在的SIP服务到WebRTC的浏览器。

用户数据交换和同步不能被轻视：你可以创建数据结构（如：JSON），使它们在服务器和所有客户端间同步，每一次来自客户端或服务器的修改都自动地、直接地、透明地影响其他所有客户端。

想像一个会议参与人的动态列表，或者聊天室，或证券行情，或一个多用户游戏，等等。

——————————————————————————————————————————
配置mod_verto
——————————————————————————————————————————

mod_verto在FreeSWITCH中被默认安装，看一下配置文件verto.conf.xml。

这里是最重要的参数，ext-rtp-ip，如果服务器位于NAT后面，必须将这个参数设为外网IP，以使客户端能够访问。

另一个重要的参数是编码字符串，有两个参数决定在SDP的媒体协商中被使用，将列出所有推荐和接受的媒体类型。WebRTC强制支持VP8视频编码，强制支持OPUS和PCMU/PCMA（如：g711）音频编码。PCMU和PCMA在CPU使用上比OPUS少得多。所以，如果你想设置低质量（g711是"老PSTM"音频质量），你可以使用『PCMU、PCMA、VP8』，这样不管是客户端还是服务器，对于音频处理都会使用很少的CPU。

这能做出差异，并在某些情况下非常有意义的设置。如：如果你必须 处理非常低效的设备。同时，如果你打电话或接听来自PSTN的电话，它们可能没有OPUS高清音频，直接提供原始的g711音频流好过对OPUS的解码和重编码。

——————————————————————————————————————————
通讯测试
——————————————————————————————————————————

一旦配置好，你要测试mod_verto，你就知道Verto通讯多好，一个JavaScript视频会议和合作高级客户端。

如果还没完成，复制Verto通讯分发目录（/usr/src/freeswitch.git/html5/verto/verto_communication/dist）到你配置了SSL的Web Server下。

要看到所有效果，请确定从两个不同的客户端呼叫，一个作为参与者，一个作为主持人，你将会有控制选项来管理这个会议，如：提交floor，屏幕共享，为每一个参与者创建名称和头衔的商标，实时聊天，等等。能使用JavaScript和mod_verto做的事非常多。

——————————————————————————————————————————
建立你自己的Verto应用
——————————————————————————————————————————

最简单的基于Verto客户端的示例，完整的语音和视频呼叫和实时聊天。

这个示例非常容易理解、又短，又好学习它如何工作，多使用浏览器的JavaScript调试。示例将使用bootstrap使按键和字体好看点。

Index.html包含内容很少：部分CSS和浏览器兼容，设置了一些值用来给JavaScript。它包含一个video的HTML标签。

——————————————————————————————————————————
问题记录
——————————————————————————————————————————

# 网外网的RTP问题记录：

当像下面这样增加外网地址时，内网1V1呼叫的被呼叫方的RTP会收到外网地址，然后双方都没有画面。

<param name="ext-rtp-ip" value="180.173.155.172"/>

但是，当没有上面这个配置时，外网用户拨打FreeSWITCH的RTP地址不能收到外网地址，所以也会出错。

——————————————————————————————————————————
Verto使用
——————————————————————————————————————————

似乎啥也不用动


















































